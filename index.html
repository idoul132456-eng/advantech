<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HiveMQ ‚Üî Advantech Web Controller</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .status { padding: 5px 10px; border-radius: 4px; display: inline-block; }
    .connected { background-color: #c8f7c5; }
    .disconnected { background-color: #f7c5c5; }
    .device { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .led { display: inline-block; width: 15px; height: 15px; border-radius: 50%; margin-left: 5px; vertical-align: middle; }
    .on { background-color: green; }
    .off { background-color: red; }
    #monitor { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
  </style>

  <!-- Load Paho MQTT library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>

</head>
<body>

  <h2>HiveMQ ‚Üî Advantech Web Controller</h2>
  <div id="connectionStatus" class="status disconnected">üî¥ Disconnected</div>

  <div class="controls">
    <label>Device MAC:</label>
    <input type="text" id="macInput" placeholder="74FE4887206A">
    <button onclick="addDevice()">Add Device</button>
  </div>

  <div id="devices"></div>

  <h3>Monitoring</h3>
  <div id="monitor"></div>

  <script>
    const broker = "d2f277161aef4f56a41ef426746a4219.s1.eu.hivemq.cloud";
    const port = 8883;  // Secure WebSocket port
    const username = "user1";
    const password = "User1234";
    let client;
    const devices = {};

    // Logging helper
    function log(msg) {
      const monitor = document.getElementById("monitor");
      const time = new Date().toLocaleTimeString();
      monitor.innerHTML += `[${time}] ${msg}<br>`;
      monitor.scrollTop = monitor.scrollHeight;
    }

    // MQTT callbacks
    function onConnect() {
      log("‚úÖ Connected to HiveMQ");
      const status = document.getElementById("connectionStatus");
      status.className = "status connected";
      status.innerText = "üü¢ Connected";

      // Subscribe to all devices
      client.subscribe("Advantech/+/data");
    }

    function onFail(response) {
      log("‚ùå Connection failed: " + response.errorMessage);
    }

    function onConnectionLost(response) {
      if (response.errorCode !== 0) {
        log("‚ö† Connection lost: " + response.errorMessage);
        const status = document.getElementById("connectionStatus");
        status.className = "status disconnected";
        status.innerText = "üî¥ Disconnected";
      }
    }

    function onMessageArrived(message) {
      log(`üì© Topic: ${message.destinationName}, Payload: ${message.payloadString}`);

      const parts = message.destinationName.split('/');
      const mac = parts[1];
      if (devices[mac]) {
        const deviceDiv = devices[mac];
        const dataDiv = deviceDiv.querySelector(".device-data");
        const led = deviceDiv.querySelector(".led");

        dataDiv.innerText = message.payloadString;

        const payload = message.payloadString.toUpperCase();
        if (payload === "ON") {
          led.classList.remove("off");
          led.classList.add("on");
        } else if (payload === "OFF") {
          led.classList.remove("on");
          led.classList.add("off");
        }
      }
    }

    // Add a new device
    function addDevice() {
      const mac = document.getElementById("macInput").value.trim();
      if (!mac) return alert("Please enter a device MAC.");
      if (devices[mac]) return alert("Device already added.");

      const deviceDiv = document.createElement("div");
      deviceDiv.className = "device";
      deviceDiv.innerHTML = `
        <h4>Device ${mac}</h4>
        <div>Status: <span class="led off"></span></div>
        <div class="device-data">No data yet</div>
        <button onclick="sendCommand('${mac}', 'ON')">Turn ON</button>
        <button onclick="sendCommand('${mac}', 'OFF')">Turn OFF</button>
      `;

      document.getElementById("devices").appendChild(deviceDiv);
      devices[mac] = deviceDiv;

      client.subscribe(`Advantech/${mac}/data`);
    }

    // Send command
    function sendCommand(mac, cmd) {
      if (!client || !client.isConnected()) return log("‚ö† Not connected yet.");
      const topic = `Advantech/${mac}/command`;
      const message = new Paho.MQTT.Message(cmd);
      message.destinationName = topic;
      client.send(message);
      log(`‚û° Sent command "${cmd}" to ${mac}`);
    }

    // Connect to MQTT
    function connectMQTT() {
      client = new Paho.MQTT.Client(broker, port, "/mqtt", "webclient-" + Math.random().toString(16).substr(2, 8));

      const options = {
        useSSL: true,
        userName: username,
        password: password,
        timeout: 5,
        onSuccess: onConnect,
        onFailure: onFail
      };

      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      log("Connecting to HiveMQ...");
      client.connect(options);
    }

    window.addEventListener("load", connectMQTT);
  </script>
</body>
</html>
